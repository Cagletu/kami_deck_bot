<!-- static/arena.html - –£–ü–†–û–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kami Deck - –ê—Ä–µ–Ω–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            min-height: 100vh;
            padding: 10px;
        }
        
        .arena-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #fff;
            font-size: 2em;
            margin-bottom: 5px;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }
        
        .turn-counter {
            color: #4ecdc4;
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        
        .battlefield {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .team {
            flex: 1;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .team h2 {
            text-align: center;
            margin-bottom: 15px;
            color: #fff;
        }
        
        .team.user h2 { color: #4ecdc4; }
        .team.opponent h2 { color: #ff6b6b; }
        
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }
        
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .card.dead {
            opacity: 0.3;
            filter: grayscale(100%);
        }
        
        .card.attacking {
            border-color: #4ecdc4;
            animation: attackShake 0.3s ease;
        }
        
        .card.defending {
            border-color: #ff6b6b;
            animation: defendShake 0.3s ease;
        }
        
        @keyframes attackShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes defendShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(3px); }
            75% { transform: translateX(-3px); }
        }
        
        .card-image {
            width: 100%;
            aspect-ratio: 1/1.4;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .card-name {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 4px;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .card-stats {
            font-size: 11px;
            color: #aaa;
        }
        
        .rarity-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-bottom: 4px;
        }
        
        .rarity-SSS { background: gold; color: black; }
        .rarity-S { background: purple; color: white; }
        .rarity-A { background: blue; color: white; }
        .rarity-B { background: green; color: white; }
        .rarity-C { background: gray; color: white; }
        
        .health-bar {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #4cd964, #5ac8fa);
            transition: width 0.3s ease;
        }
        
        .health-fill.low {
            background: linear-gradient(90deg, #ff3b30, #ff6b6b);
        }
        
        .synergy-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #feca57;
            color: black;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .battle-log {
            background: #0a0a0f;
            color: #fff;
            padding: 15px;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-bottom: 1px solid #333;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .log-critical {
            color: #ffd700;
            font-weight: bold;
        }
        
        .log-dodge {
            color: #4ecdc4;
        }
        
        .damage-number {
            position: absolute;
            color: #ff3b30;
            font-weight: bold;
            font-size: 16px;
            animation: floatUp 1s ease forwards;
            pointer-events: none;
            z-index: 1000;
        }
        
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #autoBattleBtn {
            background: linear-gradient(135deg, #4ecdc4, #45b7aa);
            color: white;
        }
        
        #closeBtn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .victory-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .victory-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            animation: popIn 0.5s ease;
            border: 2px solid #4ecdc4;
        }
        
        @keyframes popIn {
            0% { transform: scale(0); }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .victory-content h2 {
            font-size: 3em;
            margin-bottom: 20px;
            color: #4ecdc4;
        }
        
        .victory-content.defeat h2 {
            color: #ff6b6b;
        }
        
        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .battlefield {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="arena-container">
        <div class="header">
            <h1>‚öîÔ∏è –ê–†–ï–ù–ê ‚öîÔ∏è</h1>
            <div class="turn-counter" id="turnCounter">–•–æ–¥: 0</div>
        </div>
        
        <div class="battlefield">
            <div class="team user">
                <h2>‚öîÔ∏è –í–ê–®–ê –ö–û–õ–û–î–ê</h2>
                <div class="cards-grid" id="userTeam"></div>
            </div>
            
            <div class="team opponent">
                <h2>üëπ –ü–†–û–¢–ò–í–ù–ò–ö</h2>
                <div class="cards-grid" id="opponentTeam"></div>
            </div>
        </div>
        
        <div class="battle-log" id="battleLog"></div>
        
        <div class="controls">
            <button id="autoBattleBtn">‚ö° –ê–í–¢–û–ë–û–ô</button>
            <button id="closeBtn">üè† –ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>
    
    <div class="victory-screen" id="victoryScreen">
        <div class="victory-content" id="victoryContent"></div>
    </div>
    
    <script>
        let battle = null;
        let autoBattleInterval = null;
        let isAutoBattling = false;
        let currentTurn = 0;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.text = "–ó–ê–ö–†–´–¢–¨";
        tg.MainButton.onClick(() => tg.close());
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        window.addEventListener('load', () => {
            const initData = tg.initDataUnsafe;
            if (initData && initData.battle_state) {
                renderBattle(initData.battle_state);
            }
        });
        
        function renderBattle(state) {
            if (!state) return;
            
            currentTurn = state.turn;
            document.getElementById('turnCounter').textContent = `–•–æ–¥: ${currentTurn}`;
            
            renderTeam('userTeam', state.user_cards, state.synergies.user);
            renderTeam('opponentTeam', state.opponent_cards, state.synergies.opponent);
            
            if (state.winner) {
                stopAutoBattle();
                showVictory(state.winner === 'user');
            }
        }
        
        function renderTeam(containerId, cards, synergies) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            cards.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = `card ${!card.is_alive ? 'dead' : ''}`;
                cardEl.id = `card-${card.id}`;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω–µ—Ä–≥–∏–∏
                if (synergies && card.anime && synergies[card.anime]) {
                    const synergyBadge = document.createElement('div');
                    synergyBadge.className = 'synergy-badge';
                    synergyBadge.textContent = synergies[card.anime];
                    cardEl.appendChild(synergyBadge);
                }
                
                const healthPercent = (card.health / card.max_health) * 100;
                
                cardEl.innerHTML += `
                    <div class="rarity-badge rarity-${card.rarity}">${card.rarity}</div>
                    <img src="${card.image_url}" class="card-image" alt="${card.name}">
                    <div class="card-name">${card.name}</div>
                    <div class="card-stats">‚öîÔ∏è ${card.attack} | üõ°Ô∏è ${card.defense}</div>
                    <div class="health-bar">
                        <div class="health-fill ${healthPercent < 30 ? 'low' : ''}" 
                             style="width: ${healthPercent}%"></div>
                    </div>
                    <div class="card-stats">‚ù§Ô∏è ${card.health}/${card.max_health}</div>
                    <div class="card-stats">üìà –£—Ä.${card.level}</div>
                `;
                
                container.appendChild(cardEl);
            });
        }
        
        function addLogEntry(text, type = 'normal') {
            const log = document.getElementById('battleLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            if (type === 'critical') {
                entry.innerHTML = `‚ö° <span class="log-critical">${text}</span>`;
            } else if (type === 'dodge') {
                entry.innerHTML = `üí® <span class="log-dodge">${text}</span>`;
            } else {
                entry.innerHTML = `üí• ${text}`;
            }
            
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        function showDamage(cardId, damage) {
            const card = document.getElementById(`card-${cardId}`);
            if (!card) return;
            
            const rect = card.getBoundingClientRect();
            const damageEl = document.createElement('div');
            damageEl.className = 'damage-number';
            damageEl.textContent = `-${damage}`;
            damageEl.style.left = rect.left + rect.width/2 + 'px';
            damageEl.style.top = rect.top + 'px';
            
            document.body.appendChild(damageEl);
            
            setTimeout(() => damageEl.remove(), 1000);
        }
        
        function animateAttack(attackerId, defenderId) {
            const attacker = document.getElementById(`card-${attackerId}`);
            const defender = document.getElementById(`card-${defenderId}`);
            
            if (attacker) {
                attacker.classList.add('attacking');
                setTimeout(() => attacker.classList.remove('attacking'), 300);
            }
            
            if (defender) {
                defender.classList.add('defending');
                setTimeout(() => defender.classList.remove('defending'), 300);
            }
        }
        
        function showVictory(isVictory) {
            const screen = document.getElementById('victoryScreen');
            const content = document.getElementById('victoryContent');
            
            if (isVictory) {
                content.className = 'victory-content';
                content.innerHTML = `
                    <h2>üèÜ –ü–û–ë–ï–î–ê!</h2>
                    <p style="font-size: 1.2em; margin-bottom: 20px; color: white;">–í—ã —É–Ω–∏—á—Ç–æ–∂–∏–ª–∏ –∫–æ–ª–æ–¥—É –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞!</p>
                    <p style="color: #4ecdc4;">üí∞ +150 –º–æ–Ω–µ—Ç</p>
                    <p style="color: #4ecdc4;">‚ú® +25 –ø—ã–ª–∏</p>
                    <p style="color: #4ecdc4;">‚≠ê +20 —Ä–µ–π—Ç–∏–Ω–≥–∞</p>
                `;
            } else {
                content.className = 'victory-content defeat';
                content.innerHTML = `
                    <h2>üòî –ü–û–†–ê–ñ–ï–ù–ò–ï</h2>
                    <p style="font-size: 1.2em; margin-bottom: 20px; color: white;">–í–∞—à–∞ –∫–æ–ª–æ–¥–∞ –ø–∞–ª–∞ –≤ –±–æ—é</p>
                    <p style="color: #ff6b6b;">üí∞ +50 –º–æ–Ω–µ—Ç</p>
                    <p style="color: #ff6b6b;">‚ú® +10 –ø—ã–ª–∏</p>
                    <p style="color: #ff6b6b;">‚≠ê -5 —Ä–µ–π—Ç–∏–Ω–≥–∞</p>
                `;
            }
            
            screen.style.display = 'flex';
            setTimeout(() => {
                screen.style.display = 'none';
                tg.MainButton.show();
            }, 3000);
        }
        
        function stopAutoBattle() {
            if (autoBattleInterval) {
                clearInterval(autoBattleInterval);
                autoBattleInterval = null;
            }
            isAutoBattling = false;
            document.getElementById('autoBattleBtn').textContent = '‚ö° –ê–í–¢–û–ë–û–ô';
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        document.getElementById('autoBattleBtn').addEventListener('click', () => {
            if (isAutoBattling) {
                stopAutoBattle();
            } else {
                document.getElementById('autoBattleBtn').textContent = '‚è∏ –°–¢–û–ü';
                isAutoBattling = true;
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π —Ö–æ–¥
                tg.sendData(JSON.stringify({action: 'next_turn'}));
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–±–æ–π
                autoBattleInterval = setInterval(() => {
                    tg.sendData(JSON.stringify({action: 'next_turn'}));
                }, 1500);
            }
        });
        
        document.getElementById('closeBtn').addEventListener('click', () => {
            stopAutoBattle();
            tg.close();
        });
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'battle_update') {
                const update = event.data;
                
                renderBattle(update.state);
                
                if (update.actions) {
                    update.actions.forEach(action => {
                        showDamage(action.defender_id, action.damage);
                        animateAttack(action.attacker_id, action.defender_id);
                        
                        let logText = `${action.attacker_name} ‚Üí ${action.defender_name}`;
                        if (action.is_critical) {
                            logText += ` –ö–†–ò–¢! (-${action.damage})`;
                            addLogEntry(logText, 'critical');
                        } else if (action.is_dodged) {
                            logText += ` –ü–†–û–ú–ê–•!`;
                            addLogEntry(logText, 'dodge');
                        } else {
                            logText += ` ${action.damage} —É—Ä–æ–Ω–∞`;
                            addLogEntry(logText);
                        }
                    });
                }
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç –±–æ—Ç–∞
        tg.onEvent('web_app_data_sent', (data) => {
            try {
                const response = JSON.parse(data);
                if (response.type === 'battle_update') {
                    const event = new MessageEvent('message', { data: response });
                    window.dispatchEvent(event);
                }
            } catch (e) {
                console.error('Error parsing response:', e);
            }
        });
    </script>
</body>
</html>